name: Deploy Psychology Experiment to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build and deploy job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate experiment files
        run: |
          echo "Validating experiment structure..."

          # Check required files exist
          if [ ! -f "index.html" ]; then
            echo "Error: index.html not found"
            exit 1
          fi

          if [ ! -d "js" ]; then
            echo "Error: js directory not found"
            exit 1
          fi

          if [ ! -d "css" ]; then
            echo "Error: css directory not found"  
            exit 1
          fi

          if [ ! -d "images" ]; then
            echo "Error: images directory not found"
            exit 1
          fi

          if [ ! -f "data/stimuli-config.json" ]; then
            echo "Error: data/stimuli-config.json not found"
            exit 1
          fi

          # Validate stimuli-config.json structure
          if ! grep -q '"imageTrials"' data/stimuli-config.json; then
            echo "Error: stimuli-config.json missing imageTrials section"
            exit 1
          fi

          if ! grep -q '"neutralFillers"' data/stimuli-config.json; then
            echo "Error: stimuli-config.json missing neutralFillers section"
            exit 1
          fi

          echo "âœ“ All required files present"

          # Count images for experiment validation
          ORIGINAL_COUNT=$(find images/original -name "*.jpg" -o -name "*.JPG" | wc -l)
          FILLER_COUNT=$(find images/filler -name "*.jpg" -o -name "*.JPG" | wc -l)

          echo "Image counts:"
          echo "- Original/Stimulus images: $ORIGINAL_COUNT"
          echo "- Filler images: $FILLER_COUNT"

          # Validate minimum requirements based on stimuli-config.json structure
          # The config defines 12 image trials, each needing 4 emotional images (dysphoric, threat, positive, neutral)
          # Plus 8 filler trials with 4 filler images each = 32 filler images total
          if [ $ORIGINAL_COUNT -lt 48 ]; then
            echo "Warning: May not have enough original images for experiment (need 48+ for 12 trials Ã— 4 emotional categories)"
          fi

          if [ $FILLER_COUNT -lt 32 ]; then
            echo "Warning: May not have enough filler images for experiment (need 32+ for 8 filler trials Ã— 4 images)"
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Display deployment URL
        run: |
          echo "ðŸŽ‰ Experiment deployed successfully!"
          echo "ðŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "The psychology experiment is now live and accessible to participants."
